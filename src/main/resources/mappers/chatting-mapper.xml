<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chattingMapper">


	<resultMap type="Message" id="message_rm">
		<id property="messageNo" column="MESSAGE_NO" />
		<result property="messageContent" column="MESSAGE_CONTENT" />
		<result property="readFlag" column="READ_FL" />
		<result property="senderNo" column="SENDER_NO" />
		<result property="sendTime" column="SEND_TIME" />
		<result property="petSitterNo" column="PETSITTER_NO" />
	</resultMap>


	<resultMap type="Member" id="member_rm">
		<id property="memberNo" column="MEMBER_NO" />
		<result property="memberEmail" column="MEMBER_EMAIL" />
		<result property="memberNickname" column="MEMBER_NICKNAME" />
		<result property="profileImage" column="PROFILE_IMG" />
	</resultMap>

	<resultMap type="PetSitter" id="PetSitter_rm">
		<id property="petSitterNo" column="PETSITTER_NO" />
		<result property="location" column="LOCATION" />
		<result property="career" column="CAREER" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="memberEmail" column="MEMBER_EMAIL" />
		<result property="memberTel" column="MEMBER_TEL" />
		<result property="profileImg" column="PROFILE_IMG" />
		<result property="memberNm" column="MEMBER_NM" />
	</resultMap>

	<resultMap type="Reservation" id="Reservation_rm">
		<id property="rsNo" column="RS_NO" />

		<result property="rsDate" column="RS_DATE" />
		<result property="rsStartDate" column="RS_START_TIME" />
		<result property="petSitterNo" column="PETSITTER_NO" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="serviceType" column="SERVICE_TYPE" />
		<result property="serviceTime" column="SERVICE_TIME" />
		<result property="servicePrice" column="SERVICE_PRICE" />
	</resultMap>

	<!-- 해당펫시터 번호 조회 -->
	<select id="selectPetsitterNo" resultMap="Reservation_rm">
		SELECT PETSITTER_NO,
		MEMBER_NO FROM RESERVATION
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<!-- 채팅방 메세지 조회 -->
	<select id="selectMessageList" resultMap="message_rm">
		SELECT MESSAGE_NO,
		MESSAGE_CONTENT, READ_FL, SENDER_NO, PETSITTER_NO,
		TO_CHAR(SEND_TIME,
		'YYYY.MM.DD HH24:MI') SEND_TIME
		FROM CHATTING_MESSAGE
		WHERE PETSITTER_NO
		= #{petsitterNo}
		ORDER BY MESSAGE_NO
	</select>

	<!-- 채팅 메세지 중 내가 보내지 않은 글을 읽음으로 표시 -->
	<update id="updateReadFlag">
		UPDATE "CHATTING_MESSAGE" SET
		READ_FL = 'Y'
		WHERE
		PETSITTER_NO = #{petsitterNo}
		AND SENDER_NO != #{memberNo}
	</update>

	<!-- 채팅 메세지 삽입 -->
	<insert id="insertMessage">
		INSERT INTO "CHATTING_MESSAGE"
		VALUES(SEQ_MESSAGE_NO.NEXTVAL, #{messageContent},#{senderNo}, SYSDATE,
		DEFAULT, #{petsitterNo})
	</insert>


</mapper>
